<span class="hljs-comment">/**
 * <span class="hljs-doctag">@license</span>
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.dev/license
 */</span>

<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Combobox</span>,
  <span class="hljs-title class_">ComboboxInput</span>,
  <span class="hljs-title class_">ComboboxPopup</span>,
  <span class="hljs-title class_">ComboboxPopupContainer</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@angular/aria/combobox&#x27;</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Tree</span>, <span class="hljs-title class_">TreeItem</span>, <span class="hljs-title class_">TreeItemGroup</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@angular/aria/tree&#x27;</span>;
<span class="hljs-keyword">import</span> {
  afterRenderEffect,
  <span class="hljs-title class_">ChangeDetectionStrategy</span>,
  <span class="hljs-title class_">Component</span>,
  computed,
  <span class="hljs-title class_">ElementRef</span>,
  signal,
  viewChild,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@angular/core&#x27;</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-variable constant_">TREE_NODES</span>, <span class="hljs-title class_">TreeNode</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../data&#x27;</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">NgTemplateOutlet</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@angular/common&#x27;</span>;

<span class="hljs-comment">/** <span class="hljs-doctag">@title</span> Combobox with tree popup and highlight filtering. */</span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">&#x27;combobox-tree-highlight-example&#x27;</span>,
  <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">&#x27;combobox-tree-highlight-example.html&#x27;</span>,
  <span class="hljs-attr">styleUrl</span>: <span class="hljs-string">&#x27;../combobox-examples.css&#x27;</span>,
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">Combobox</span>,
    <span class="hljs-title class_">ComboboxInput</span>,
    <span class="hljs-title class_">ComboboxPopup</span>,
    <span class="hljs-title class_">ComboboxPopupContainer</span>,
    <span class="hljs-title class_">Tree</span>,
    <span class="hljs-title class_">TreeItem</span>,
    <span class="hljs-title class_">TreeItemGroup</span>,
    <span class="hljs-title class_">NgTemplateOutlet</span>,
  ],
  <span class="hljs-attr">changeDetection</span>: <span class="hljs-title class_">ChangeDetectionStrategy</span>.<span class="hljs-property">OnPush</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComboboxTreeHighlightExample</span> {
  popover = viewChild&lt;<span class="hljs-title class_">ElementRef</span>&gt;(<span class="hljs-string">&#x27;popover&#x27;</span>);
  tree = viewChild&lt;<span class="hljs-title class_">Tree</span>&lt;<span class="hljs-title class_">TreeNode</span>&gt;&gt;(<span class="hljs-title class_">Tree</span>);
  combobox = viewChild&lt;<span class="hljs-title class_">Combobox</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(<span class="hljs-title class_">Combobox</span>);

  searchString = <span class="hljs-title function_">signal</span>(<span class="hljs-string">&#x27;&#x27;</span>);

  nodes = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">filterTreeNodes</span>(<span class="hljs-variable constant_">TREE_NODES</span>));

  firstMatch = computed&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> flatNodes = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flattenTreeNodes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">nodes</span>());
    <span class="hljs-keyword">const</span> node = flatNodes.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isMatch</span>(n));
    <span class="hljs-keyword">return</span> node?.<span class="hljs-property">name</span>;
  });

  <span class="hljs-title function_">flattenTreeNodes</span>(<span class="hljs-attr">nodes</span>: <span class="hljs-title class_">TreeNode</span>[]): <span class="hljs-title class_">TreeNode</span>[] {
    <span class="hljs-keyword">return</span> nodes.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> node.<span class="hljs-property">children</span> ? [node, ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flattenTreeNodes</span>(node.<span class="hljs-property">children</span>)] : [node];
    });
  }

  <span class="hljs-title function_">filterTreeNodes</span>(<span class="hljs-attr">nodes</span>: <span class="hljs-title class_">TreeNode</span>[]): <span class="hljs-title class_">TreeNode</span>[] {
    <span class="hljs-keyword">return</span> nodes.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, node</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> children = node.<span class="hljs-property">children</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">filterTreeNodes</span>(node.<span class="hljs-property">children</span>) : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isMatch</span>(node) || (children &amp;&amp; children.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)) {
        acc.<span class="hljs-title function_">push</span>({...node, children});
      }
      <span class="hljs-keyword">return</span> acc;
    }, [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">TreeNode</span>[]);
  }

  <span class="hljs-title function_">isMatch</span>(<span class="hljs-params"><span class="hljs-attr">node</span>: <span class="hljs-title class_">TreeNode</span></span>) {
    <span class="hljs-keyword">return</span> node.<span class="hljs-property">name</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">searchString</span>().<span class="hljs-title function_">toLowerCase</span>());
  }

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title function_">afterRenderEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> popover = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">popover</span>()!;
      <span class="hljs-keyword">const</span> combobox = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">combobox</span>()!;
      combobox.<span class="hljs-title function_">expanded</span>() ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showPopover</span>() : popover.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">hidePopover</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tree</span>()?.<span class="hljs-title function_">scrollActiveItemIntoView</span>();
    });
  }

  <span class="hljs-title function_">showPopover</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> popover = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">popover</span>()!;
    <span class="hljs-keyword">const</span> combobox = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">combobox</span>()!;

    <span class="hljs-keyword">const</span> comboboxRect = combobox.<span class="hljs-title function_">inputElement</span>()?.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> popoverEl = popover.<span class="hljs-property">nativeElement</span>;

    <span class="hljs-keyword">if</span> (comboboxRect) {
      popoverEl.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${comboboxRect.width}</span>px`</span>;
      popoverEl.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${comboboxRect.bottom}</span>px`</span>;
      popoverEl.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${comboboxRect.left - <span class="hljs-number">1</span>}</span>px`</span>;
    }

    popover.<span class="hljs-property">nativeElement</span>.<span class="hljs-title function_">showPopover</span>();
  }
}
